trigger:
  - 'master'
  - 'develop'
  - 'feature/*'
  - 'release/*'

name: $(Build.DefinitionName)-$(SourceBranchName)-$(Date:yyyyMMdd)$(Rev:.r)
pool:
  vmImage: 'ubuntu-latest'

variables:
  containerRegistry: 'NextJS'

steps:
  - task: DeleteFiles@1
    displayName: 'Remove robots.txt in production'
    condition: and(succeeded(), or(eq(variables['Build.SourceBranchName'], 'main'), eq(variables['Build.SourceBranchName'], 'master')))
    inputs:
      Contents: 'public/robots.txt'

  - task: Docker@2
    displayName: 'Docker - Test'
    condition: and(succeeded(), not(eq(variables['Build.SourceBranchName'], 'main'), eq(variables['Build.SourceBranchName'], 'master'), eq(variables['Build.SourceBranchName'], 'acceptance')))
    inputs:
      containerRegistry: '$(containerRegistry)'
      repository: 'reactsetup-acr-test'
      command: 'buildAndPush'
      Dockerfile: '**/Dockerfile'
      tags: |
        $(Build.BuildId)
        latest

  - task: Docker@2
    displayName: 'Docker - Acc'
    condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'acceptance'))
    inputs:
      containerRegistry: '$(containerRegistry)'
      repository: 'reactsetup-acr-test'
      command: 'buildAndPush'
      Dockerfile: '**/Dockerfile'
      tags: |
        $(Build.BuildId)
        latest

  - task: Docker@2
    displayName: 'Docker - Prod'
    condition: and(succeeded(), or(eq(variables['Build.SourceBranchName'], 'main'), eq(variables['Build.SourceBranchName'], 'master')))
    inputs:
      containerRegistry: '$(containerRegistry)'
      repository: 'reactsetup-acr-test'
      command: 'buildAndPush'
      Dockerfile: '**/Dockerfile'
      tags: |
        $(Build.BuildId)
        latest

